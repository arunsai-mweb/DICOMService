@using DiagoDICOM.Common;
@using DiagoDICOM.Models;
@model IEnumerable<CaseStudies>
@{
	ViewData["Title"] = "Home Page";
}

<script src="~/js/Dialogs.js"></script>
<script>

	var getUrl = window.location;
	var baseUrl = getUrl.protocol + "//" + getUrl.host + "/";
	$(document).ready(function () {

		$('.multilinks > li > a').removeClass('active');
		$('.multilinks > li > a.tab3').addClass('active');

		function formatCases(d, clientId) {
			var table = '<table id="tblStatus" class="table table-striped" style="width:90%;margin-left:5%">'
			$.ajax({
				url: baseUrl + "Home/GetStudyStatus?studyId=" + d[8] + "&clientId=" + parseInt($(d[9]).val()),
				type: "Get",
				async: false,
				traditional: true,
				success: function (response) {
					console.log(response)
					table += '<thead><tr><th>Image Id</th><th>Client Status</th><th>Destination Status</th><th>Action</th></tr ></thead >'
					$(response).each(function (i, data) {
						table += '<tbody><td>' + data.sopInstanceUID + '</td>' + '<td>' + data.clientStatus + '</td>' + '<td>' + data.destinationStatus + '</td>'
						table += '<td style="width:110px"><button class="btn btn-secondary btn-sm" title="View Logs" id="btnLogs" onclick="getLogs(this)" data-sopInstanceUID="' + data.sopInstanceUID + '"><i class="fa fa-history"></i ></button>'
					})
				}

			})
			table += '</table>'
			return table;
		}

		var table = $('#tblCases').DataTable({
			//"bSearchable":false,
			processing: "true",
			responsive: {
				
			},
			"bSort": false,
			"bLengthChange": false,
			language: {
				search: "_INPUT_",
				searchPlaceholder: "Search..."
			},
			"columns": [
				{ "width": "3%" },
				{ "width": "8%" },
				{ "width": "10%" },
				{ "width": "9%" },
				{ "width": "7%" },
				{ "width": "5%" },
				{ "width": "10%" },
				{ "width": "10%" },
				{ "width": "20%" },
				{"Width":"10%" }
			],
			order: [1, 'asc']
		});

		var dataTable = $('#tblCases').dataTable();
		$("#searchbox").keyup(function () {
			dataTable.fnFilter(this.value);
		});

		var table = $('#tblCases').DataTable();
		$('#ClientId').on('change', function () {
			table.columns(1).search(this.value).draw();
		});
		$('#DestinationId').on('change', function () {
			table.columns(2).search(this.value).draw();
		});
		$('#ModalityId').on('change', function () {
			table.columns(5).search(this.value).draw();
		});
	});

	function getLogs(e) {
		$.get(baseUrl + "Home/GetLogs", { SopInstanceId: $(e).data('sopinstanceuid') }, function (html) {
			var div = $(html);
			$.dialog("Logs", div, function () {
			}, function () {
				$(".modal-dialog").removeClass("modal-lg");
			});
		});
	}

	function DeleteStudies(e)
	{
		if (confirm("Are you sure to delete the selected studies")) {
			var array = [];
			$('.chkStudy:checkbox:checked').each(function () {
				array.push($(this).val());
				console.log($(this).val());
			})
			$.post('@Url.Action("DeleteStudies","Home")', { studyIds: array.join() }, function () {
				window.location.reload();
			//$.notify({
			//	message: "Deleted Successfully"
			//}, {
			//		type: "danger"
			//	});
		    })
		}
		else {
			return false;
		}
	}
</script>


<style>
	.modal-content {
		width: 760px;
	}
	table.dataTable {
		border-collapse: collapse !important;
	}
	table.dataTable tbody td {
			word-break: break-word;
			vertical-align: top;
		}
</style>

<div class="row">
	<div class="col-md-2 col-xs-2 col-lg-2 col-sm-2">
		<input type="text" class="form-control" placeholder="Search" id="searchbox" style="width:200px">
	</div>
	<div class="col-md-2 col-xs-2 col-lg-2 col-sm-2">
		<div class="form-group">
			@Html.DropDownList("DestinationId", ViewData["Destinations"] as IEnumerable<SelectListItem>, "Select Destination", new { @class = "form-control", @style = "width:200px" })
		</div>
	</div>
	<div class="col-md-2 col-xs-2 col-lg-2 col-sm-2">
		<div class="form-group">
			@Html.DropDownList("ClientId", ViewData["Clients"] as IEnumerable<SelectListItem>, "Select Client", new { @class = "form-control", @style = "width:200px" })
		</div>
	</div>
	@*<div class="col-md-2 col-xs-2 col-lg-2 col-sm-2">
		<div class="form-group">
			@Html.DropDownList("ModalityId", ViewData["Modalities"] as IEnumerable<SelectListItem>, "Select Modality", new { @class = "form-control", @style = "width:200px" })
		</div>
	</div>*@
</div>

<div class="table-responsive">
	<table id="tblCases" class="table table-bordered table-hover" style="width:100%">
		<thead style="">
			<tr>
				@if (Model.Count() > 0)
				{
					<th><button type="button" class="btn btn-sm btn-danger" title="Delete Studies" onclick="DeleteStudies()"><i class="fa fa-trash"></i></button></th>
				}
				else
				{
					 <th></th>
				}
					<th>Client</th>
					<th>Destination</th>
					<th>Patient Id</th>
					<th>Image Count</th>
					<th>Modality</th>
					<th>Sent On</th>
				    <th>Date of Service</th>
					<th>Study Id</th>
				    <th>Status</th>
				</tr>
		</thead>
		<tbody>
			@if (Model.Count() > 0)
			{
				foreach (var item in Model.GroupBy(x => new { x.ClientId , x.DICOMStudyID}))
				{
					var data = item.FirstOrDefault();
			<tr>
				<td><input type="checkbox"  value="@data.DICOMStudyID" class="chkStudy checkbox-lg"></td>
				<td>@data.ClientName</td>
				<td>@data.DestinationName</td>
				<td>@data.PatientId</td>
				<td>@item.Count()</td>
				<td>@data.Modality</td>
				<td>@data.CreatedOn</td>
				<td>@data.ScanDate</td>
				<td>@data.DICOMStudyID</td>
				<td></td>
			</tr>
				}
			}
			else
			{

			}

		</tbody>
	</table>
	</div>







